# simple-web-proxy-sample
プロキシサーバーの簡易的な実装です。C++, Haskell, PHPでそれぞれ作成してみました。

## プロキシサーバーの仕組み
HTTPのプロキシサーバーは以下の仕組みになっています

**※注**<br>
・プロキシサーバーから別のプロキシサーバーに転送することもできますが今回は省略しています<br>
・他にも実装しやすいように省略したり変えたりしている部分があります（大枠の流れは仕様通りです）

#### HTTPSの場合
1. クライアントがプロキシサーバーに以下の形式のリクエストを送信する
   * `CONNECT ${Webサイトのドメイン}:${ポート番号} HTTP/1.1`（例: `CONNECT www.google.co.jp:443 HTTP/1.1`）
2. プロキシサーバーはリクエストに含まれるドメイン（上記の例だと`www.google.co.jp`）・ポート番号（上記の例だと`443`）を使用して目的のサーバーに接続する
3. 手順2でのサーバーへの接続の成否に応じて、以下の操作をする
   * サーバーへの接続が成功した場合
     1. クライアントにステータスコード`2xx`のレスポンスを返す（例: `HTTP 200 Connection established`）
     2. クライアント側・サーバー側どちらかの接続が切れるまで、クライアントから送信されたデータをサーバーに、サーバーから送信されたデータをクライアントに送信する
     3. どちらかの接続が切れたら、もう一方の接続も切る
   * サーバーへの接続が失敗した場合
     1. クライアントに`HTTP/1.1 400 Bad Request`のレスポンスを返す（正確な仕様通りかは分かりませんが問題なく動きます）

#### HTTPの場合
1. クライアントがプロキシサーバーに、目的のサーバーに送信したい内容と同じ内容のリクエストを送信する
   * 但し、リクエストのパスは完全な形式のURLにする（例: `GET http://www.google.co.jp/search?q=proxy HTTP/1.1`）
2. プロキシサーバーはリクエストに含まれるドメイン（上記の例だと`www.google.co.jp`）を使用して目的のサーバーの80番ポートに接続する
   * サーバーへの接続が成功した場合
     1. 手順1で取得したリクエストのURLをパス・クエリのみに変更し（上記の例だと`/search?q=proxy`）、サーバーに送信する
     2. サーバーから返ってきたレスポンスをクライアントに送信する
     3. 以降はクライアント側・サーバー側どちらかの接続が切れるまで以下の手順を繰り返す
        1. クライアントからリクエストを読み込み、URLを変更し、サーバーに送信する
        2. サーバーから返ってきたレスポンスをクライアントに送信する
     4. どちらかの接続が切れたら、もう一方の接続も切る
   * サーバーへの接続が失敗した場合
     1. プロキシサーバーはクライアントに`HTTP/1.1 400 Bad Request`を返す（多分仕様通りではないですが一応動きます）

#### 関係するRFC
* [RFC9110](https://datatracker.ietf.org/doc/html/rfc9110)
* [RFC9112](https://datatracker.ietf.org/doc/html/rfc9112)

## 動作確認
### プロキシサーバーの動作
#### プロキシサーバーが接続を待ち受けるポート番号について
デフォルトだと8080番ポートで接続を受け付けます。コマンドライン引数にポート番号（`8000`など）を渡すと、そのポートで接続を受け付けます。

#### プロキシサーバーが出力するログについて
プロキシサーバーが接続を受け付けると、標準エラー出力（C++版の場合）または標準出力（Haskell版・PHP版の場合）にログを出力します。

### 確認方法
#### 端末・ブラウザにプロキシ設定をして確認する場合
1. 確認に使用したい端末・ブラウザでプロキシ設定をする（下にある **プロキシを設定する方法** を参照）
2. 好きなWebサイトにアクセスする

**※** プロキシサーバーが動作している端末や同じ端末のブラウザの場合、IPアドレスに`localhost`や`127.0.0.1`を設定しても同じように動作します

#### curlを使用する場合
* HTTPSプロキシの動作を確認したい場合
```
curl -v -x http://${IPアドレス}:${ポート番号}/ https://www.google.co.jp/
```
* HTTPプロキシの動作を確認したい場合
```
curl -v -x http://${IPアドレス}:${ポート番号}/ http://www.google.co.jp/
```

## プロキシを設定する方法
#### iPhone・iPad
1. プロキシサーバーが動作しているPCと、確認に使用したい端末を同じネットワーク（同じWiFi）に接続する
2. 設定アプリ > Wi-Fi > 現在接続中のWi-Fiのiボタンをタップする
3. 一番下までスクロールし、「プロキシを構成」をタップする
4. 「手動」を選択する
5. 「サーバ」にプロキシサーバーが動作しているPCのローカルIPアドレス（`192.168.0.8`など）、「ポート」にプロキシサーバーが接続を受け付けているポート番号（`8080`など）を入力する
6. 「保存」をタップする

#### Windows
1. 設定 > ネットワークとインターネット > プロキシを開く
2. 「手動プロキシ セットアップ」の「プロキシ サーバーを使う」をオンにする
3. 「アドレス」にプロキシサーバーが動作しているPCのローカルIPアドレス（`192.168.0.8`など）、「ポート」にプロキシサーバーが接続を受け付けるポート番号（`8080`など）を入力する
4. （「ローカル（イントラネット）のアドレスにはプロキシ サーバーを使わない」はオフのままにしておく）
5. 「保存」を押下する

#### macOS（Sonoma）
1. 設定 > ネットワークを開き、PCのネットワークの接続方法（Wi-Fi, Ethernetなど）を選択する
2. 「詳細」ボタンを押下する
3. サイドメニューの「プロキシ」を押下する
4. 「Webプロキシ (HTTP)」をオンにする
5. 「サーバ」にプロキシサーバーが動作しているPCのローカルIPアドレス（`192.168.0.8`など）、「ポート」にプロキシサーバーが接続を受け付けているポート番号（`8080`など）を入力する
6. 「保護されたWebプロキシ (HTTPS)」でも手順4, 5と同じようにする
7. 「OK」を押下する

#### Google Chrome
起動オプション付きのコマンドで起動する。${IPアドレス}にはプロキシサーバーが動作しているPCのローカルIPアドレス（`192.168.0.8`など）、${ポート番号}にはプロキシサーバーが接続を受け付けるポート番号（`8080`など）を入力する

* Windowsの場合<br>
${chrome.exeのパス}: `C:¥Program Files (x86)¥Google¥Chrome¥Application¥chrome.exe`など
```
"${chrome.exeのパス}" --proxy-server=${IPアドレス}:${ポート番号}
```
* macOSの場合
```
open -a "Google Chrome" --args --proxy-server=${IPアドレス}:${ポート番号}
```

#### Firefox
1. 設定 > 一般を開く
2. 一番下までスクロールし、「ネットワーク設定」の「接続設定」を押下する
3. 「手動でプロキシを設定する」を選択する
4. 「HTTPプロキシー」の右の入力欄にプロキシサーバーが動作しているPCのローカルIPアドレス（`192.168.0.8`など）を入力する
5. 「HTTPプロキシー」と同じ行の「ポート」の右の入力欄にプロキシサーバーが接続を受け付けているポート番号（`8080`など）を入力する
6. 「このプロキシーをHTTPSでも使用する」にチェックを入れる
7. 「OK」を押下する
