# simple-web-proxy-sample
プロキシサーバーの簡易的な実装です。C++, Haskell, PHPでそれぞれ作成してみました。

## プロキシサーバーの仕組み
HTTPのプロキシサーバーは以下の仕組みになっています

**関係するRFC**<br>
・[RFC9110](https://datatracker.ietf.org/doc/html/rfc9110)<br>
・[RFC9112](https://datatracker.ietf.org/doc/html/rfc9112)

**※注**<br>
・プロキシサーバーから別のプロキシサーバーに転送することもできますが今回は省略しています<br>
・他にも実装しやすいように省略したり変えたりしている部分があります（大枠の流れは仕様通りです）

#### HTTPSの場合
1. クライアントがプロキシサーバーに以下の形式のCONNECTメソッドのリクエストを送信する
   * `CONNECT ${Webサイトのドメイン}:${ポート番号} HTTP/1.1`（例: `CONNECT www.google.co.jp:443 HTTP/1.1`）
2. プロキシサーバーはリクエストに含まれるドメイン・ポート番号を使用して目的のサーバーに接続する
3. 手順2でのサーバーへの接続の成否に応じて、以下の操作をする
   * サーバーへの接続が成功した場合
     1. クライアントにステータスコード`2xx`のレスポンスを返す（例: `HTTP 200 Connection established`）
     2. クライアント側・サーバー側どちらかの接続が切れるまで、クライアントから送信されたデータをサーバーに、サーバーから送信されたデータをクライアントに送信する
     3. どちらかの接続が切れたら、もう一方の接続も切る
   * サーバーへの接続が失敗した場合
     1. クライアントに`HTTP/1.1 400 Bad Request`のレスポンスを返す（正確な仕様通りかは分かりませんが問題なく動きます）

#### HTTPの場合
1. クライアントがプロキシサーバーに、目的のサーバーに送信したい内容と同じ内容のリクエストを送信する
   * 但し、リクエストのパスは完全な形式のURLにする（例: `GET http://www.google.co.jp/search?q=proxy HTTP/1.1`）
2. プロキシサーバーはリクエストに含まれるドメイン（上記の例だと`www.google.co.jp`）を使用して目的のサーバーの80番ポートに接続する
   * サーバーへの接続が成功した場合
     1. 手順1で取得したリクエストのURLをパス・クエリのみに変更し（上記の例だと`/search?q=proxy`）、サーバーに送信する
     2. サーバーから返ってきたレスポンスをクライアントに送信する
     3. 以降はクライアント側・サーバー側どちらかの接続が切れるまで以下の手順を繰り返す
        1. クライアントからリクエストを読み込み、URLを変更し、サーバーに送信する
        2. サーバーから返ってきたレスポンスをクライアントに送信する
     4. どちらかの接続が切れたら、もう一方の接続も切る
   * サーバーへの接続が失敗した場合
     1. プロキシサーバーはクライアントに`HTTP/1.1 400 Bad Request`を返す（多分仕様通りではないですが一応動きます）
